<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KYC Frontend Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <meta name="csrf-token" content="test-token">
    <meta name="user-id" content="3">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h4>KYC Frontend Test</h4>
                    </div>
                    <div class="card-body">
                        <div id="debug-info" class="alert alert-info">
                            <h5>Debug Information:</h5>
                            <div id="debug-content"></div>
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="testKycEndpoint()">
                            <i class="fas fa-play me-2"></i>
                            Test KYC Endpoint
                        </button>
                        
                        <button type="button" class="btn btn-secondary ms-2" onclick="testStatusCheck()">
                            <i class="fas fa-check me-2"></i>
                            Test Status Check
                        </button>
                        
                        <div id="results" class="mt-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Debug information
        function updateDebugInfo() {
            const debugContent = document.getElementById('debug-content');
            const csrfToken = document.querySelector('meta[name="csrf-token"]');
            const userId = document.querySelector('meta[name="user-id"]');
            
            debugContent.innerHTML = `
                <p><strong>Current URL:</strong> ${window.location.href}</p>
                <p><strong>Origin:</strong> ${window.location.origin}</p>
                <p><strong>CSRF Token:</strong> ${csrfToken ? csrfToken.getAttribute('content') : 'Not found'}</p>
                <p><strong>User ID:</strong> ${userId ? userId.getAttribute('content') : 'Not found'}</p>
                <p><strong>User Agent:</strong> ${navigator.userAgent}</p>
            `;
        }
        
        function showResult(title, data, isError = false) {
            const results = document.getElementById('results');
            const alertClass = isError ? 'alert-danger' : 'alert-success';
            const icon = isError ? 'fas fa-exclamation-triangle' : 'fas fa-check-circle';
            
            results.innerHTML = `
                <div class="alert ${alertClass}">
                    <h5><i class="${icon} me-2"></i>${title}</h5>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                </div>
            `;
        }
        
        function testKycEndpoint() {
            const csrfToken = document.querySelector('meta[name="csrf-token"]');
            
            if (!csrfToken) {
                showResult('Error', 'CSRF token not found', true);
                return;
            }
            
            console.log('Testing KYC endpoint...');
            console.log('CSRF Token:', csrfToken.getAttribute('content'));
            console.log('Request URL:', window.location.origin + '/kyc/start');
            
            fetch('/kyc/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': csrfToken.getAttribute('content'),
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));
                
                const contentType = response.headers.get('content-type');
                console.log('Content-Type:', contentType);
                
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('Error response body:', text);
                        throw new Error(`HTTP ${response.status}: ${text}`);
                    });
                }
                
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                } else {
                    return response.text().then(text => {
                        throw new Error(`Non-JSON response: ${text}`);
                    });
                }
            })
            .then(data => {
                console.log('Success response:', data);
                showResult('KYC Endpoint Test - Success', data);
            })
            .catch(error => {
                console.error('Error:', error);
                showResult('KYC Endpoint Test - Error', {
                    message: error.message,
                    stack: error.stack
                }, true);
            });
        }
        
        function testStatusCheck() {
            const csrfToken = document.querySelector('meta[name="csrf-token"]');
            const userId = document.querySelector('meta[name="user-id"]');
            
            if (!csrfToken) {
                showResult('Error', 'CSRF token not found', true);
                return;
            }
            
            if (!userId) {
                showResult('Error', 'User ID not found', true);
                return;
            }
            
            console.log('Testing status check...');
            
            fetch('/kyc/check-status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': csrfToken.getAttribute('content'),
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    user_id: userId.getAttribute('content')
                })
            })
            .then(response => {
                console.log('Status check response status:', response.status);
                
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`HTTP ${response.status}: ${text}`);
                    });
                }
                
                return response.json();
            })
            .then(data => {
                console.log('Status check success:', data);
                showResult('Status Check Test - Success', data);
            })
            .catch(error => {
                console.error('Status check error:', error);
                showResult('Status Check Test - Error', {
                    message: error.message,
                    stack: error.stack
                }, true);
            });
        }
        
        // Initialize debug info on page load
        document.addEventListener('DOMContentLoaded', updateDebugInfo);
    </script>
</body>
</html>