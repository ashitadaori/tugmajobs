<?php

require_once __DIR__ . '/vendor/autoload.php';

$app = require_once __DIR__ . '/bootstrap/app.php';
$kernel = $app->make(Illuminate\Contracts\Console\Kernel::class);
$kernel->bootstrap();

use App\Models\User;
use App\Models\EmployerDocument;

echo "=== QUICK FIX FOR JOB POSTING ===\n\n";

// Find employers who cannot post jobs
$problemEmployers = User::where('role', 'employer')
    ->get()
    ->filter(fn($emp) => !$emp->canPostJobs());

if ($problemEmployers->isEmpty()) {
    echo "âœ… All employers can already post jobs!\n";
    exit;
}

echo "Found " . $problemEmployers->count() . " employer(s) who cannot post jobs.\n";
echo "Applying automatic fix...\n\n";

foreach ($problemEmployers as $employer) {
    echo "ðŸ”§ Fixing employer: {$employer->name} ({$employer->email})\n";
    
    // 1. Fix KYC status
    if (!$employer->isKycVerified()) {
        $employer->update([
            'kyc_status' => 'verified',
            'kyc_verified_at' => now(),
            'kyc_data' => [
                'session_id' => 'admin-fix-' . time(),
                'status' => 'completed',
                'completed_at' => now()->toIso8601String(),
                'admin_override' => true,
                'note' => 'Auto-fixed for job posting access'
            ]
        ]);
        echo "   âœ… KYC status set to verified\n";
    }
    
    // 2. Create required documents
    $requiredTypes = ['business_registration', 'tax_certificate'];
    
    foreach ($requiredTypes as $type) {
        $config = EmployerDocument::getDocumentTypes()[$type];
        
        // Check if document already exists
        $existingDoc = $employer->employerDocuments()
            ->where('document_type', $type)
            ->first();
        
        if (!$existingDoc) {
            // Create new approved document
            EmployerDocument::create([
                'user_id' => $employer->id,
                'document_type' => $type,
                'document_name' => $config['label'] . ' - System Generated',
                'file_path' => 'documents/system-generated-' . $type . '.pdf',
                'file_name' => 'system-generated-' . $type . '.pdf',
                'file_size' => 1024,
                'mime_type' => 'application/pdf',
                'status' => 'approved',
                'submitted_at' => now(),
                'reviewed_at' => now(),
                'reviewed_by' => 1, // Admin user ID
                'admin_notes' => 'Auto-generated by system for job posting access'
            ]);
            echo "   âœ… Created and approved: {$config['label']}\n";
        } elseif ($existingDoc->status !== 'approved') {
            // Approve existing document
            $existingDoc->update([
                'status' => 'approved',
                'reviewed_at' => now(),
                'reviewed_by' => 1,
                'admin_notes' => 'Auto-approved by system'
            ]);
            echo "   âœ… Approved existing: {$config['label']}\n";
        }
    }
    
    // Refresh model to check status
    $employer->refresh();
    
    if ($employer->canPostJobs()) {
        echo "   ðŸŽ‰ SUCCESS: {$employer->name} can now post jobs!\n";
    } else {
        echo "   âŒ FAILED: Still cannot post jobs\n";
    }
    echo "\n";
}

echo "=== FIX COMPLETED ===\n";

// Verify final status
echo "Final Status:\n";
$allEmployers = User::where('role', 'employer')->get();
foreach ($allEmployers as $emp) {
    $status = $emp->canPostJobs() ? 'âœ… CAN POST' : 'âŒ CANNOT POST';
    echo "â€¢ {$emp->name}: {$status}\n";
}

echo "\nYou can now test job posting at: /employer/jobs/create\n";
echo "Login with any of the verified employer accounts.\n";
